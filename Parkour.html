<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3D Platform Game</title>
  <style>
    body { 
      margin: 0; 
      overflow: hidden; 
      font-family: Arial, sans-serif;
    }
    canvas { 
      display: block; 
    }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      background: rgba(0,0,0,0.7);
      padding: 15px;
      border-radius: 5px;
      font-size: 14px;
    }
    canvas {
      cursor: default;
    }
  </style>
</head>

<body>
  <div id="info">
    <strong>Controls:</strong><br>
    WASD - Move<br>
    Space - Jump<br>
    Tab - Toggle First-Person (pointer lock & mouse look)<br>
    Esc - Release pointer lock / exit FPS
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  
  <script>
    let scene
    let camera 
    let renderer
    let player
    let ground
    let platforms = [];
    let keys = {};
    let velocity = new THREE.Vector3();
    let direction = new THREE.Vector3();
    let canJump = false;
    const GRAVITY = -30;
    const JUMP_FORCE = 15;
    const MOVE_SPEED = 18;
    const PLAYER_HALF_HEIGHT = 1; // player box height is 2, so half is 1

    let yaw = 0;   // rotation around Y

    let pitch = 0; // rotation around X
    const turnSpeed = 1.78; // radians per second

    const MOUSE_SENSITIVITY = 0.0025;

    const Y_AXIS = new THREE.Vector3(0, 1, 0);
    const yawQuat = new THREE.Quaternion();
    const forward = new THREE.Vector3();

    function init() {
      // Scene
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x87ceeb);
      scene.fog = new THREE.Fog(0x87ceeb, 0, 100);

      // Camera
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 15, 20);
      camera.lookAt(0, 0, 0);

      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      document.body.appendChild(renderer.domElement);

      // Lighting
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);

      const dirLight = new THREE.DirectionalLight(0xffffff, 0.3);
      dirLight.position.set(5, 10, 5);
      dirLight.castShadow = true;
      dirLight.shadow.camera.left = -20;
      dirLight.shadow.camera.right = 20;
      dirLight.shadow.camera.top = 20;
      dirLight.shadow.camera.bottom = -20;
      scene.add(dirLight);

      // Ground
      const groundGeo = new THREE.BoxGeometry(50, 1, 50);
      const groundMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
      ground = new THREE.Mesh(groundGeo, groundMat);
      ground.receiveShadow = true;
      ground.position.y = -0.5;
      scene.add(ground);

      // Player (cube character)
      const playerGeo = new THREE.BoxGeometry(1, 2, 1);
      const playerMat = new THREE.MeshStandardMaterial({ color: 0xff4444 });
      player = new THREE.Mesh(playerGeo, playerMat);
      player.castShadow = true;
      player.position.set(0, 3, 0);
      scene.add(player);

      // Create platforms
      const platformMaterial = new THREE.MeshStandardMaterial({ color: 0x8B5A2B });
      function createPlatform(x, z, width, depth, centerY) {
        const geo = new THREE.BoxGeometry(width, 1, depth); // fixed thickness = 1
        const mesh = new THREE.Mesh(geo, platformMaterial);
        mesh.receiveShadow = true;
        mesh.position.set(x, centerY, z);
        scene.add(mesh);
        platforms.push(mesh);
      }

      // Several example platforms (x, z, width, depth, centerY)
      createPlatform(0, -8, 6, 6, 2.5);
      createPlatform(7, -2, 4, 4, 4.0);
      createPlatform(-7, 3, 3, 6, 6.0);
      createPlatform(10, 8, 8, 3, 3.5);
      createPlatform(-12, -6, 5, 5, 5.5);
      createPlatform(3, 12, 6, 6, 8.0);

      const wallGeo  = new THREE.BoxGeometry(2,100,50);
      const wallMat  = new THREE.MeshStandardMaterial({color: 0x99004F});
      const wallMesh = new THREE.Mesh(wallGeo, wallMat);
      wallMesh.position.set(-26, 0, -26);
      wallMesh.receiveShadow = true;
      scene.add(wallMesh);



      // Event listeners
      document.addEventListener('keydown', onKeyDown);
      document.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);
      window.addEventListener('resize', onWindowResize);
    }

    function onKeyDown(e) {
      // Normal movement keys
      keys[e.key.toLowerCase()] = true;
    }


    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function checkPlatformCollisions() {
      // simple AABB collision checks for landing on top of platforms while falling
      const EPS = 0.05;
      const playerBottom = player.position.y - PLAYER_HALF_HEIGHT;

      for (let p of platforms) {
        // geometry.parameters exists for BoxGeometry created directly
        const halfW = (p.geometry.parameters.width) / 2;
        const halfD = (p.geometry.parameters.depth) / 2;
        const topY = p.position.y + (p.geometry.parameters.height) / 2; // height = 1 => top = center + 0.5

        // check XZ overlap
        const withinX = player.position.x > (p.position.x - halfW) && player.position.x < (p.position.x + halfW);
        const withinZ = player.position.z > (p.position.z - halfD) && player.position.z < (p.position.z + halfD);

        // Only consider landing if player is over platform horizontally and falling (or stationary vertically)
        if (withinX && withinZ && velocity.y <= 0) {
          // If player's bottom is at or just below the platform top (within EPS)
          if (playerBottom <= topY + EPS && (playerBottom >= topY - 2)) {
            // Snap to platform top
            player.position.y = topY + PLAYER_HALF_HEIGHT;
            velocity.y = 0;
            canJump = true;
            return; // landed on a platform; no need to check others this frame
          }
        }
      }
    }

    function updatePlayer(delta) {
      // Gravity
      velocity.y += GRAVITY * delta;

      // Rotation
      if (keys.a) yaw += turnSpeed * delta;
      if (keys.d) yaw -= turnSpeed * delta;

      yawQuat.setFromAxisAngle(Y_AXIS, yaw);
      player.quaternion.copy(yawQuat);

      // Movement input
      let move = 0;
      if (keys.w) move += 1;
      if (keys.s) move -= 1;

      if (move !== 0) {
        forward.set(0, 0, -1).applyQuaternion(player.quaternion);
        velocity.x = forward.x * MOVE_SPEED * move;
        velocity.z = forward.z * MOVE_SPEED * move;
      } else {
        velocity.x *= 0.9;
        velocity.z *= 0.9;
      }

      // Jump
      if ((keys[' '] || keys['space']) && canJump) {
        velocity.y = JUMP_FORCE;
        canJump = false;
      }

      // Apply movement
      player.position.addScaledVector(velocity, delta);

      checkPlatformCollisions();

      // Ground
      if (player.position.y <= 1) {
        player.position.y = 1;
        velocity.y = 0;
        canJump = true;
      }
    }



    function updateCamera(deltaTime) {

        yawQuat.setFromAxisAngle(Y_AXIS, yaw);
        // --- 4. Rotate camera offset around the player ---
        const cameraOffset = new THREE.Vector3(0, 6, 12); // up + back
        const rotatedOffset = cameraOffset.clone().applyQuaternion(yawQuat);

        const desiredCameraPos = player.position.clone().add(rotatedOffset);

        // Smooth camera movement
        camera.position.lerp(desiredCameraPos, 0.08);

        // --- 5. Look at the player (slightly above center) ---
        camera.lookAt(
            player.position.x,
            player.position.y + 1.2,
            player.position.z
        );
    }


    function animate() {
      requestAnimationFrame(animate);
      
      const delta = 0.016; // Approximately 60fps
      updatePlayer(delta);
      updateCamera(delta);
      
      renderer.render(scene, camera);
    }

    init();
    animate();
  </script>
</body>
</html>
